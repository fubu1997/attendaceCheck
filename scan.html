<!-- ATTENDANCECHECK/scan.html (음성 안내 추가 버전) -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>QR 스캔 &amp; 출석 체크</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="css/style.css" />
  <script src="js/jsQR.js"></script>
  <script src="employees.js"></script>
</head>
<body>
  <div class="container">
    <h1>QR 스캔으로 출석 체크</h1>
    <p>전면 카메라를 통해 화면을 보면서 QR을 인식하세요.</p>

    <!-- 전면 카메라 영상 -->
    <video id="video" autoplay playsinline style="transform: scaleX(-1);"></video>
    <canvas id="canvas" hidden></canvas>

    <!-- 상태 메시지 -->
    <div id="status">스캔 대기 중...</div>

    <!-- 오늘 출석자 리스트 -->
    <div id="attended-list">
      <h2>오늘 출석자</h2>
      <ul id="list"></ul>
    </div>
  </div>

  <!-- 출석 완료 팝업 -->
  <div id="toast-popup">출석이 완료되었습니다</div>

  <script>
    // 오늘 날짜를 YYYY-MM-DD 형태로 반환
    function getTodayStr() {
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const dd = String(now.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    // DOM 로드 시 출석 데이터 초기화, 스캐너 실행
    document.addEventListener("DOMContentLoaded", () => {
      const todayStr = getTodayStr();
      const savedDate = localStorage.getItem("attendance_date");
      if (savedDate !== todayStr) {
        localStorage.setItem("attendance", JSON.stringify([]));
        localStorage.setItem("attendance_date", todayStr);
      }
      refreshAttendanceList();
      startScanner().catch(err => {
        console.error(err);
        document.getElementById("status").textContent = "카메라 접근 오류.";
      });
    });

    // 출석 리스트 렌더링
    function refreshAttendanceList() {
      const listElem = document.getElementById("list");
      listElem.innerHTML = "";
      const records = JSON.parse(localStorage.getItem("attendance")) || [];
      records.forEach(rec => {
        const li = document.createElement("li");
        li.textContent = `${rec.name} (${rec.id}) - ${rec.time}`;
        listElem.appendChild(li);
      });
    }

    // 토스트 팝업 표시 (3초간)
    function showToast(message) {
      const toast = document.getElementById("toast-popup");
      toast.textContent = message;
      toast.style.display = "block";
      setTimeout(() => {
        toast.style.display = "none";
      }, 3000);
    }

    // 음성으로 안내하기 (여성 한국어 목소리 시도)
    function speak(text) {
      // 1) Utterance 객체 생성
      const msg = new SpeechSynthesisUtterance(text);
      msg.lang = 'ko-KR'; // 한국어
      // 2) available voices 중 한국어 여성 목소리 찾기
      const voices = window.speechSynthesis.getVoices();
      if (voices.length > 0) {
        // 예시로 'Google 한국의 여성 목소리' 같은 이름을 가진 것을 우선 선택
        const femaleKorean = voices.find(v => 
          v.lang.startsWith('ko') && v.name.toLowerCase().includes('female')
        ) || voices.find(v =>
          v.lang.startsWith('ko') && v.name.toLowerCase().includes('korean')
        );
        if (femaleKorean) {
          msg.voice = femaleKorean;
        }
      }
      // 3) 출력
      window.speechSynthesis.speak(msg);
    }

    // QR 스캔 & 출석 체크 로직 (전면 카메라)
    async function startScanner() {
      const video = document.getElementById("video");
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      const statusElem = document.getElementById("status");

      // 전면 카메라 요청
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "user" }
      });
      video.srcObject = stream;
      video.style.transform = "scaleX(-1)"; // 거울 효과

      video.addEventListener("loadedmetadata", () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
      });

      function tick() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, imageData.width, imageData.height, {
            inversionAttempts: "dontInvert"
          });

          if (code) {
            const raw = code.data.trim(); // 예: "HC001|2025-06-10"
            console.log("스캔된 QR 데이터:", raw);

            const parts = raw.split("|");
            if (parts.length !== 2) {
              statusElem.textContent = "유효하지 않은 QR 코드입니다.";
            } else {
              const [scannedId, scannedDate] = parts;
              const today = getTodayStr();

              if (scannedDate !== today) {
                statusElem.textContent = "오늘자 QR이 아닙니다.";
              } else {
                const emp = employees.find(e => e.id === scannedId);
                if (!emp) {
                  statusElem.textContent = "등록되지 않은 직원입니다.";
                } else {
                  let records = JSON.parse(localStorage.getItem("attendance")) || [];
                  const already = records.some(r => r.id === scannedId);
                  if (already) {
                    statusElem.textContent = "이미 출석 처리되었습니다.";
                  } else {
                    const nowTime = new Date().toLocaleTimeString();
                    records.push({ id: emp.id, name: emp.name, time: nowTime });
                    localStorage.setItem("attendance", JSON.stringify(records));
                    statusElem.textContent = `${emp.name}님 출석 완료 (${nowTime})`;
                    refreshAttendanceList();

                    // **음성 안내** + **팝업**
                    speak("출석이 완료되었습니다");
                    showToast("출석이 완료되었습니다");
                  }
                }
              }
            }
          } else {
            statusElem.textContent = "스캔 대기 중...";
          }
        }
        requestAnimationFrame(tick);
      }

      requestAnimationFrame(tick);
    }
  </script>
</body>
</html>
